<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Omni-AI Chat App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
        :root {
            --sidebar-bg-light: #f9fafb;
            --sidebar-text-light: #1f2937;
            --sidebar-border-light: #e5e7eb;
            --sidebar-hover-light: #e5e7eb;

            --sidebar-bg-dark: #100a1c;
            --sidebar-text-dark: #d1d5db;
            --sidebar-border-dark: #374151;
            --sidebar-hover-dark: #374151;
        }
        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s, color 0.3s;
            display: flex;
            background-color: #100a1c; /* Base dark purple color */
        }

        /* Animated particle background */
        .particle-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background-color: transparent;
        }

        .particle {
            position: absolute;
            background-color: rgba(255, 255, 255, 0.5);
            border-radius: 50%;
            pointer-events: none;
            animation-name: float-random;
            animation-timing-function: ease-in-out;
            animation-iteration-count: infinite;
        }

        /* More transparent particles when the chat is active to be less distracting */
        body.chat-active .particle {
            background-color: rgba(255, 255, 255, 0.1);
        }

        @keyframes float-random {
            0% {
                transform: translate(0, 0) scale(1) rotate(0deg);
            }
            25% {
                transform: translate(calc(20vw - 10%), calc(-20vh + 10%)) scale(1.1) rotate(15deg);
            }
            50% {
                transform: translate(calc(40vw - 20%), calc(-40vh + 20%)) scale(1.2) rotate(-10deg);
            }
            75% {
                transform: translate(calc(60vw - 30%), calc(-60vh + 30%)) scale(1.1) rotate(5deg);
            }
            100% {
                transform: translate(0, 0) scale(1) rotate(0deg);
            }
        }

        .sidebar {
            width: 280px;
            background-color: var(--sidebar-bg-light);
            color: var(--sidebar-text-light);
            border-left: 1px solid var(--sidebar-border-light);
            position: fixed;
            top: 0;
            right: 0;
            bottom: 0;
            display: flex;
            flex-direction: column;
            padding: 1.5rem;
            z-index: 20;
            transition: transform 0.3s ease-in-out;
            transform: translateX(100%);
            overflow-y: auto;
        }

        .sidebar.expanded {
            transform: translateX(0);
        }

        .main-content {
            padding: 1.5rem;
            background-color: transparent; /* Changed to transparent */
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            transition: margin-right 0.3s;
            flex-grow: 1;
            margin-right: 0;
        }

        .main-content.sidebar-open {
            margin-right: 280px;
        }

        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(100%);
            }
        }
        .card {
            background-color: rgba(255, 255, 255, 0.2); /* Semi-transparent */
            border-radius: 1.5rem;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            transition: all 0.3s ease-in-out;
            /* Multi-colored box shadow for glowing effect */
            box-shadow:
                0 0 10px rgba(76, 29, 149, 0.3),
                0 0 15px rgba(234, 88, 12, 0.3),
                0 0 20px rgba(6, 182, 212, 0.3);
        }

        .card:hover {
            transform: translateY(-8px); /* Lifts the card */
            box-shadow:
                0 10px 20px rgba(76, 29, 149, 0.6),
                0 10px 25px rgba(234, 88, 12, 0.6),
                0 10px 30px rgba(6, 182, 212, 0.6);
        }
        .welcome-screen-card {
            background-color: rgba(255, 255, 255, 0.2); /* Semi-transparent */
            padding: 2.5rem;
            text-align: center;
            border-radius: 2.5rem;
            max-width: 32rem;
            width: 100%;
            transition: all 0.3s ease-in-out;
            box-shadow:
                0 0 10px rgba(76, 29, 149, 0.3),
                0 0 15px rgba(234, 88, 12, 0.3),
                0 0 20px rgba(6, 182, 212, 0.3);
        }
        .welcome-screen-card:hover {
            transform: translateY(-8px);
            box-shadow:
                0 10px 20px rgba(76, 29, 149, 0.6),
                0 10px 25px rgba(234, 88, 12, 0.6),
                0 10px 30px rgba(6, 182, 212, 0.6);
        }

        .bottom-bar {
            position: sticky;
            bottom: 0;
            padding: 1rem 1.5rem;
            z-index: 1000;
            transition: background-color 0.3s, box-shadow 0.3s;
        }
        .toggle-switch-container { display: flex; align-items: center; }
        .toggle-switch-container .toggle-checkbox { display: none; }
        .toggle-switch-container .toggle-label { position: relative; display: inline-block; width: 48px; height: 28px; background-color: #e5e7eb; border-radius: 28px; transition: background-color 0.2s; cursor: pointer; }
        .toggle-switch-container .toggle-checkbox:checked + .toggle-label { background-color: #4f46e5; }
        .toggle-switch-container .toggle-label::after { content: ''; position: absolute; top: 3px; left: 3px; width: 22px; height: 22px; background-color: white; border-radius: 50%; transition: transform 0.2s; }
        .toggle-switch-container .toggle-checkbox:checked + .toggle-label::after { transform: translateX(20px); }
        .dynamic-island { background-color: #e5e7eb; border-radius: 9999px; padding: 0.5rem 1rem; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); display: flex; align-items: center; gap: 1rem; }

        @keyframes box-spin { 0% { transform: rotate(0deg); border-radius: 0; } 25% { transform: rotate(90deg); border-radius: 25%; } 50% { transform: rotate(180deg); border-radius: 50%; } 75% { transform: rotate(270deg); border-radius: 25%; } 100% { transform: rotate(360deg); border-radius: 0; } }
        .box-spinner { animation: box-spin 1.5s linear infinite; }

        /* --- Conversation History Styles --- */
        #chat-log-container { display: flex; flex-direction: column; gap: 1.5rem; }
        .conversation-turn { background-color: rgba(255, 255, 255, 0.5); border: 1px solid rgba(0,0,0,0.05); border-radius: 2rem; padding: 1.5rem; }
        .user-prompt { font-weight: 500; margin-bottom: 1rem; padding: 1rem; background-color: #f3f4f6; border-radius: 1rem; }

        #history-container { flex-grow: 1; overflow-y: auto; margin-top: 1rem; }
        .history-item { display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0.75rem; border-radius: 0.5rem; cursor: pointer; color: var(--sidebar-text-light); transition: background-color 0.2s, color 0.2s; }
        .history-item:hover { background-color: var(--sidebar-hover-light); }
        .history-item.active { background-color: #4f46e5; color: white; }
        .history-title { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex-grow: 1; }
        .delete-chat-btn { background: none; border: none; color: inherit; opacity: 0.6; transition: opacity 0.2s; padding: 0.25rem; display: none; }
        .history-item:hover .delete-chat-btn, .history-item.active .delete-chat-btn { display: block; }
        .delete-chat-btn:hover { opacity: 1; }

        /* --- Dark Mode Styles --- */
        body.dark { background-color: #100a1c; color: #e0e0e0; }
        body.dark .main-content { background-color: transparent; }
        body.dark .sidebar { background-color: var(--sidebar-bg-dark); color: var(--sidebar-text-dark); border-left: 1px solid var(--sidebar-border-dark); }
        body.dark .history-item { color: var(--sidebar-text-dark); }
        body.dark .history-item:hover { background-color: var(--sidebar-hover-dark); }
        body.dark .history-item.active { background-color: #4f46e5; color: white; }
        body.dark .sidebar h1, body.dark .sidebar nav a { color: #d1d5db; }
        body.dark .sidebar button.new-chat-btn { background-color: #4f46e5; }
        body.dark h1, body.dark h2, body.dark input { color: #e0e0e0; }
        body.dark p { color: #d1d5db; }
        body.dark .card, body.dark .welcome-screen-card { background-color: rgba(0,0,0,0.2); }
        body.dark .card p, body.dark .welcome-screen-card p { color: #d1d5db; }
        body.dark .card .response-text { color: #e0e0e0 !important; }
        body.dark .bottom-bar { background-color: transparent; box-shadow: none; }
        body.dark .dynamic-island { background-color: #3f3f46; }
        body.dark .toggle-switch-container .toggle-label { background-color: #555; }
        body.dark .toggle-switch-container .toggle-checkbox:checked + .toggle-label { background-color: #4f46e5; }
        body.dark .voice-input-container { background-color: #3f3f46; border-color: #555; }
        body.dark .bottom-bar input { color: #e0e0e0; }
        body.dark .bottom-bar input::placeholder { color: #a0a0a0; }
        body.dark .voice-input-container button svg { color: #a0a0a0; }
        body.dark .conversation-turn { background-color: rgba(0, 0, 0, 0.2); border-color: rgba(255,255,255,0.1); }
        body.dark .user-prompt { background-color: #374151; }
        .text-gradient {
            background-image: linear-gradient(to right, #6b46c1, #4c51bf);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        /* New gradient for the new chat button */
        .new-chat-btn {
            background-image: linear-gradient(to right, #6d28d9, #4f46e5);
            transition: all 0.2s ease-in-out;
        }

        .new-chat-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(79, 70, 229, 0.4);
        }

        /* New gradient for the main title */
        .title-gradient {
            background-image: linear-gradient(to right, #8b5cf6, #3b82f6, #06b6d4);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
    </style>
</head>
<body class="bg-gray-100 flex dark">
    <div id="particle-bg" class="particle-bg"></div>
    <!-- Main Content -->
    <div class="main-content">
        <!-- AI Selection Bar and Hamburger Menu on the same line -->
        <div class="flex flex-wrap justify-start items-center gap-4">
            <div class="dynamic-island">
                <div class="toggle-switch-container">
                    <input type="checkbox" id="chatgpt-toggle-dynamic" class="toggle-checkbox" checked>
                    <label for="chatgpt-toggle-dynamic" class="toggle-label"></label>
                </div>
                <img src="https://upload.wikimedia.org/wikipedia/commons/e/ef/ChatGPT-Logo.svg" alt="ChatGPT Logo" class="w-6 h-6 rounded-full" />
                <h2 class="text-xl font-semibold m-0">ChatGPT</h2>
            </div>
            <div class="dynamic-island">
                <div class="toggle-switch-container">
                    <input type="checkbox" id="grok-toggle-dynamic" class="toggle-checkbox" checked>
                    <label for="grok-toggle-dynamic" class="toggle-label"></label>
                </div>
                <img src="https://upload.wikimedia.org/wikipedia/commons/f/f9/Grok-icon.svg" alt="Grok Logo" class="w-6 h-6 rounded-full" />
                <h2 class="text-xl font-semibold m-0">Grok</h2>
            </div>
            <div class="dynamic-island">
                <div class="toggle-switch-container">
                    <input type="checkbox" id="gemini-toggle-dynamic" class="toggle-checkbox" checked>
                    <label for="gemini-toggle-dynamic" class="toggle-label"></label>
                </div>
                <img src="https://upload.wikimedia.org/wikipedia/commons/1/1d/Google_Gemini_icon_2025.svg" alt="Gemini Logo" class="w-6 h-6 rounded-full" />
                <h2 class="text-xl font-semibold m-0">Gemini</h2>
            </div>
            <div class="dynamic-island">
                <div class="toggle-switch-container">
                    <input type="checkbox" id="perplexity-toggle-dynamic" class="toggle-checkbox" checked>
                    <label for="perplexity-toggle-dynamic" class="toggle-label"></label>
                </div>
                <img src="https://upload.wikimedia.org/wikipedia/commons/b/b5/Perplexity_AI_Turquoise_on_White.png" alt="Perplexity Logo" class="w-6 h-6 rounded-full" />
                <h2 class="text-xl font-semibold m-0">Perplexity</h2>
            </div>
            <div class="dynamic-island">
                <div class="toggle-switch-container">
                    <input type="checkbox" id="deepseek-toggle-dynamic" class="toggle-checkbox" checked>
                    <label for="deepseek-toggle-dynamic" class="toggle-label"></label>
                </div>
                <img src="https://upload.wikimedia.org/wikipedia/commons/9/95/DeepSeek-icon.svg" alt="DeepSeek Logo" class="w-6 h-6 rounded-full" />
                <h2 class="text-xl font-semibold m-0">DeepSeek</h2>
            </div>
            <!-- Hamburger Menu Icon at the top right -->
            <button id="hamburger-menu-btn" class="ml-auto w-10 h-10 flex items-center justify-center text-gray-400 transition-all duration-300 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-full">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
            </button>
        </div>

        <div id="chat-log-container" class="flex-grow">
            <!-- Conversation turns will be appended here -->
            <div id="welcome-screen" class="flex flex-col justify-center items-center h-full">
                <div class="welcome-screen-card">
                    <h1 class="text-4xl font-bold mb-4 title-gradient">Omni-AI Chat</h1>
                    <p>Start a new conversation from the sidebar.</p>
                </div>
            </div>
        </div>

        <!-- Bottom Search Bar -->
        <div class="bottom-bar">
            <div id="imagePreviewContainer" class="hidden mb-4 p-4 rounded-lg bg-gray-200 dark:bg-gray-700 relative">
                <img id="imagePreview" src="" alt="Attached Image" class="max-w-xs max-h-48 mx-auto rounded-lg shadow-md">
                <button id="clearImageButton" class="absolute top-2 right-2 text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <div class="flex flex-col md:flex-row gap-4 items-center relative w-full">
                <div class="voice-input-container flex-grow relative flex items-center bg-white rounded-full border border-gray-300 focus-within:ring-2 focus-within:ring-indigo-500 w-full">
                    <button id="attachFileButton" class="absolute left-2 top-1/2 -translate-y-1/2 w-8 h-8 flex items-center justify-center rounded-full text-gray-500 hover:bg-gray-200 transition-colors dark:hover:bg-gray-600">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.586a6 6 0 108.486 8.486l6.586-6.415a1 1 0 00-1.414-1.414z" /></svg>
                    </button>
                    <input id="promptInput" type="text" placeholder="Type your question..." class="w-full h-full px-12 py-3 text-gray-700 bg-transparent focus:outline-none">
                    <button id="voiceInputButton" class="absolute right-2 top-1/2 -translate-y-1/2 w-8 h-8 flex items-center justify-center rounded-full text-gray-500 hover:bg-gray-200 transition-colors dark:hover:bg-gray-600">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3z" /><path d="M19 10v2a7 7 0 0 1-14 0v-2" /><line x1="12" y1="19" x2="12" y2="22" /></svg>
                    </button>
                </div>
                <input type="file" id="fileInput" accept="image/*" class="hidden">
                <button id="askAllButton" class="w-10 h-10 flex items-center justify-center text-white bg-indigo-600 rounded-full shadow-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition-transform transform hover:scale-105 disabled:bg-indigo-400 disabled:hover:scale-100">
                    <svg id="send-icon" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" d="M5 10l7-7m0 0l7 7m-7-7v18"></path></svg>
                    <svg id="loading-spinner" class="h-6 w-6 text-white hidden box-spinner" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><rect x="2" y="2" width="20" height="20" rx="2" ry="2" stroke-width="2" stroke="currentColor" fill="none" /></svg>
                </button>
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <div class="sidebar">
        <div class="flex justify-between w-full items-center mb-4">
            <h1 class="text-xl font-bold title-gradient">Omni-AI Chat</h1>
            <button id="darkToggle" class="w-10 h-10 rounded-full flex items-center justify-center text-xl transition-all duration-300 hover:bg-gray-200 dark:hover:bg-gray-700"></button>
        </div>
        <button id="newChatBtn" class="new-chat-btn text-white font-semibold rounded-lg px-4 py-2 w-full mb-4 shadow-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition-transform transform hover:scale-105">
            + New Chat
        </button>
        <div id="history-container" class="flex-grow"></div>
        <div class="mt-auto pt-6 border-t border-gray-200 dark:border-gray-700 text-center">
            <h3 class="text-lg font-bold title-gradient">OmniChat’s Future</h3>
            <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Share your killer ideas, feedback or just wanna say hey? —we’re ready to connect</p>
            <div class="mt-4 flex justify-center space-x-4">
                <a href="mailto:ai.omnichat@gmail.com" class="text-indigo-600 dark:text-indigo-400 hover:text-indigo-500 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8m-9 13h9a2 2 0 002-2V5a2 2 0 00-2-2H3a2 2 0 00-2 2v14a2 2 0 002 2z" /></svg>
                </a>
                <a href="https://twitter.com/aiomnichat" target="_blank" class="text-indigo-600 dark:text-indigo-400 hover:text-indigo-500 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M18.901 1.144C21.821-1.189 24.3 0.165 24.3 0.165 24.3 0.165 24.3 0.165 24.3 0.165c-2.433 1.411-4.833 2.508-7.2 3.193-2.367.685-4.881.93-7.551.737-2.67-.193-5.321-.776-7.85-1.748C-1.5 2.138-1.5 2.138-1.5 2.138c2.455 1.593 4.912 2.658 7.351 3.255 2.44.597 4.962.81 7.625.666 2.663-.143 5.305-.626 7.828-1.455-2.585 1.63-5.263 2.695-8.086 3.018-2.822.323-5.698.39-8.48.204-2.782-.186-5.467-.714-8.082-1.587 2.42 1.554 4.843 2.553 7.273 2.996 2.43.443 4.921.464 7.424.237 2.503-.227 5.011-.806 7.424-1.735-2.732 1.65-5.556 2.716-8.497 3.064-2.94.348-5.961.326-8.982.023-3.021-.303-6.04-.98-8.982-2.028-1.583.99-3.167 1.98-4.75 2.97-1.583.99-3.167 1.98-4.75 2.97-1.583.99-3.167 1.98-4.75 2.97-1.583.99-3.167 1.98-4.75 2.97-1.583.99-3.167 1.98-4.75 2.97-1.583.99-3.167 1.98-4.75 2.97C20.355 13.918 20.355 13.918 20.355 13.918z"/></svg>
                </a>
            </div>
            <div class="mt-2 text-center text-sm font-bold text-gray-500 dark:text-gray-400">
                <a href="mailto:ai.omnichat@gmail.com" class="hover:underline">ai.omnichat@gmail.com</a>
                <span class="mx-2">|</span>
                <a href="https://twitter.com/aiomnichat" target="_blank" class="hover:underline">X: @aiomnichat</a>
            </div>
        </div>
    </div>

    <!-- TEMPLATES -->
    <template id="history-item-template">
        <div class="history-item" data-id="">
            <span class="history-title"></span>
            <button class="delete-chat-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/><path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/></svg>
            </button>
        </div>
    </template>

    <template id="conversation-turn-template">
        <div class="conversation-turn">
            <div class="user-prompt"></div>
            <div id="ai-response-cards" class="flex flex-wrap gap-6">
                <!-- AI Cards will be injected here -->
            </div>
        </div>
    </template>

    <template id="ai-card-template">
        <div class="card flex-1 min-w-[200px]">
            <div class="flex items-center gap-4 mb-2"><h2 class="text-xl font-semibold m-0"></h2></div>
            <div class="w-24 h-1 bg-gray-200 dark:bg-gray-600 rounded-full mx-auto my-4 shadow-sm"></div>
            <p class="response-text text-gray-600 text-sm flex-grow"></p>
        </div>
    </template>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // NOTE: CHANGE THIS URL TO YOUR DEPLOYED BACKEND URL
            const BACKEND_URL = window.location.origin;

            const promptInput = document.getElementById('promptInput');
            const askAllButton = document.getElementById('askAllButton');
            const sendIcon = document.getElementById('send-icon');
            const loadingSpinner = document.getElementById('loading-spinner');
            const voiceInputButton = document.getElementById('voiceInputButton');
            const attachFileButton = document.getElementById('attachFileButton');
            const fileInput = document.getElementById('fileInput');
            const imagePreviewContainer = document.getElementById('imagePreviewContainer');
            const imagePreview = document.getElementById('imagePreview');
            const clearImageButton = document.getElementById('clearImageButton');
            const newChatBtn = document.getElementById('newChatBtn');
            const historyContainer = document.getElementById('history-container');
            const historyItemTemplate = document.getElementById('history-item-template');
            const convoTemplate = document.getElementById('conversation-turn-template');
            const aiCardTemplate = document.getElementById('ai-card-template');
            const chatLogContainer = document.getElementById('chat-log-container');
            const welcomeScreen = document.getElementById('welcome-screen');
            const sidebar = document.querySelector('.sidebar');
            const mainContent = document.querySelector('.main-content');
            const hamburgerMenuBtn = document.getElementById('hamburger-menu-btn');
            const particleBg = document.getElementById('particle-bg');

            const aiToggles = {
                chatgpt: document.getElementById('chatgpt-toggle-dynamic'),
                grok: document.getElementById('grok-toggle-dynamic'),
                gemini: document.getElementById('gemini-toggle-dynamic'),
                perplexity: document.getElementById('perplexity-toggle-dynamic'),
                deepseek: document.getElementById('deepseek-toggle-dynamic')
            };

            let attachedImageBase64 = null;
            let chatHistory = [];
            let activeChatId = null;
            let chatIdCounter = 0;

            const saveHistory = () => {
                localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
                localStorage.setItem('chatIdCounter', chatIdCounter);
                localStorage.setItem('activeChatId', activeChatId);
            };

            const loadHistory = () => {
                chatHistory = JSON.parse(localStorage.getItem('chatHistory')) || [];
                chatIdCounter = parseInt(localStorage.getItem('chatIdCounter')) || 0;
                activeChatId = localStorage.getItem('activeChatId');

                if (chatHistory.length === 0) {
                    createNewChat();
                } else {
                    if (activeChatId === null || !chatHistory.some(chat => chat.id == activeChatId)) {
                        activeChatId = chatHistory[0]?.id || null;
                    }
                    renderHistory();
                    switchChat(activeChatId);
                }
            };

            const renderHistory = () => {
                historyContainer.innerHTML = '';
                if (chatHistory.length === 0) {
                    historyContainer.innerHTML = `<p class="text-center text-sm text-gray-500 dark:text-gray-400">No chats yet.</p>`;
                    return;
                }
                chatHistory.forEach(chat => {
                    const historyItem = historyItemTemplate.content.cloneNode(true).firstElementChild;
                    historyItem.dataset.id = chat.id;
                    historyItem.querySelector('.history-title').textContent = chat.title;
                    if (chat.id == activeChatId) {
                        historyItem.classList.add('active');
                    }
                    historyItem.addEventListener('click', () => switchChat(chat.id));
                    const deleteBtn = historyItem.querySelector('.delete-chat-btn');
                    deleteBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        deleteChat(chat.id);
                    });
                    historyContainer.appendChild(historyItem);
                });
            };

            const createNewChat = () => {
                chatIdCounter++;
                const newChat = { id: chatIdCounter, title: 'New Chat', messages: [] };
                chatHistory.unshift(newChat);
                activeChatId = newChat.id;
                saveHistory();
                renderHistory();
                switchChat(newChat.id);
            };

            const switchChat = (chatId) => {
                activeChatId = chatId;
                localStorage.setItem('activeChatId', activeChatId);
                chatLogContainer.innerHTML = '';

                const chat = chatHistory.find(c => c.id == chatId);
                if (chat && chat.messages.length > 0) {
                    welcomeScreen.classList.add('hidden');
                    document.body.classList.add('chat-active');
                    chat.messages.forEach(msg => {
                        const turn = createTurnElement(msg.prompt, msg.responses);
                        chatLogContainer.appendChild(turn);
                    });
                } else {
                    chatLogContainer.appendChild(welcomeScreen);
                    welcomeScreen.classList.remove('hidden');
                    document.body.classList.remove('chat-active');
                }
                renderHistory();
            };

            const deleteChat = (chatIdToDelete) => {
                chatHistory = chatHistory.filter(chat => chat.id != chatIdToDelete);
                if (activeChatId == chatIdToDelete) {
                    activeChatId = chatHistory[0]?.id || null;
                    if (activeChatId) {
                        switchChat(activeChatId);
                    } else {
                        createNewChat();
                    }
                }
                saveHistory();
                renderHistory();
            };

            const addMessageToHistory = (prompt, responses) => {
                const chat = chatHistory.find(c => c.id == activeChatId);
                if (!chat) return;

                chat.messages.push({ prompt, responses });
                if (chat.messages.length === 1 && prompt) {
                    chat.title = prompt.substring(0, 30) + (prompt.length > 30 ? '...' : '');
                }
                saveHistory();
                renderHistory();
            };

            const createTurnElement = (prompt, responses) => {
                const turn = convoTemplate.content.cloneNode(true).firstElementChild;
                turn.querySelector('.user-prompt').textContent = prompt;
                const cardsContainer = turn.querySelector('#ai-response-cards');

                for (const ai in responses) {
                    const card = aiCardTemplate.content.cloneNode(true).firstElementChild;
                    card.dataset.ai = ai;
                    card.querySelector('h2').textContent = ai.charAt(0).toUpperCase() + ai.slice(1);
                    cardsContainer.appendChild(card);

                    // Add image here
                    const imageElement = document.createElement('img');
                    imageElement.classList.add('w-6', 'h-6', 'rounded-full');
                    imageElement.alt = `${ai.charAt(0).toUpperCase() + ai.slice(1)} Logo`;
                    if (ai === 'chatgpt') {
                         imageElement.src = 'https://upload.wikimedia.org/wikipedia/commons/e/ef/ChatGPT-Logo.svg';
                    } else if (ai === 'grok') {
                         imageElement.src = 'https://upload.wikimedia.org/wikipedia/commons/f/f9/Grok-icon.svg';
                    } else if (ai === 'gemini') {
                         imageElement.src = 'https://upload.wikimedia.org/wikipedia/commons/1/1d/Google_Gemini_icon_2025.svg';
                    } else if (ai === 'perplexity') {
                         imageElement.src = 'https://upload.wikimedia.org/wikipedia/commons/b/b5/Perplexity_AI_Turquoise_on_White.png';
                    } else if (ai === 'deepseek') {
                         imageElement.src = 'https://upload.wikimedia.org/wikipedia/commons/9/95/DeepSeek-icon.svg';
                    }

                    const headingContainer = card.querySelector('.flex');
                    if (headingContainer) {
                        headingContainer.insertBefore(imageElement, headingContainer.querySelector('h2'));
                    }

                    // Add response text here
                    const responseTextElement = card.querySelector('.response-text');
                    if (responseTextElement) {
                        responseTextElement.textContent = responses[ai];
                    }
                }
                return turn;
            };

            const handleSend = async () => {
                let prompt = promptInput.value.trim();
                const hasImage = attachedImageBase64 !== null;

                if (!prompt && !hasImage) return;

                welcomeScreen.classList.add('hidden');
                document.body.classList.add('chat-active');
                askAllButton.disabled = true;
                sendIcon.classList.add('hidden');
                loadingSpinner.classList.remove('hidden');

                const toggles = {
                    chatgpt: aiToggles.chatgpt.checked,
                    grok: aiToggles.grok.checked,
                    gemini: aiToggles.gemini.checked,
                    perplexity: aiToggles.perplexity.checked,
                    deepseek: aiToggles.deepseek.checked
                };

                const initialResponses = {};
                for (const ai in toggles) {
                    if (toggles[ai]) {
                        initialResponses[ai] = "Thinking...";
                    }
                }

                if (Object.keys(initialResponses).length === 0) {
                    askAllButton.disabled = false;
                    sendIcon.classList.remove('hidden');
                    loadingSpinner.classList.add('hidden');
                    return;
                }

                const turnElement = createTurnElement(prompt || "Image analysis", initialResponses);
                chatLogContainer.appendChild(turnElement);
                chatLogContainer.scrollTop = chatLogContainer.scrollHeight;

                const fetchPromises = [];
                const finalResponses = {};

                for (const ai in toggles) {
                    if (toggles[ai]) {
                        const promise = fetch(`${BACKEND_URL}/api/ask/${ai}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ prompt, imageBase64: attachedImageBase64 }),
                        })
                        .then(res => res.json())
                        .then(data => finalResponses[ai] = data.reply)
                        .catch(err => {
                            console.error(`Error with ${ai} API:`, err);
                            finalResponses[ai] = `Error: Failed to fetch response from ${ai}.`;
                        });
                        fetchPromises.push(promise);
                    }
                }
                
                await Promise.all(fetchPromises);

                for (const ai in finalResponses) {
                    const p = turnElement.querySelector(`[data-ai="${ai}"] .response-text`);
                    if (p) {
                         p.textContent = finalResponses[ai];
                    }
                }

                addMessageToHistory(prompt || "Image analysis", finalResponses);

                if (hasImage) {
                    attachedImageBase64 = null;
                    imagePreviewContainer.classList.add('hidden');
                    imagePreview.src = '';
                    fileInput.value = '';
                }

                promptInput.value = '';
                askAllButton.disabled = false;
                sendIcon.classList.remove('hidden');
                loadingSpinner.classList.add('hidden');
            };

            const darkToggle = document.getElementById('darkToggle');
            const body = document.body;
            const applyTheme = (theme) => {
                body.classList.toggle('dark', theme === 'dark');
                darkToggle.textContent = theme === 'dark' ? '☀️' : '🌙';
            };
            const savedTheme = localStorage.getItem('theme') || 'dark';
            applyTheme(savedTheme);
            darkToggle.addEventListener('click', () => {
                const newTheme = body.classList.contains('dark') ? 'light' : 'dark';
                localStorage.setItem('theme', newTheme);
                applyTheme(newTheme);
            });

            if ('SpeechRecognition' in window || 'webkitSpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                const recognition = new SpeechRecognition();
                recognition.continuous = false;
                recognition.interimResults = false;
                recognition.lang = 'en-US';
                let isListening = false;
                voiceInputButton.addEventListener('click', () => {
                    if (isListening) recognition.stop();
                    else try { recognition.start(); } catch (e) { console.error("Speech Recognition Error:", e); }
                });
                recognition.onstart = () => { isListening = true; voiceInputButton.classList.add('bg-indigo-200'); promptInput.placeholder = "Listening..."; };
                recognition.onresult = (event) => { promptInput.value = event.results[0][0].transcript; };
                recognition.onend = () => { isListening = false; voiceInputButton.classList.remove('bg-indigo-200'); promptInput.placeholder = "Type your question..."; };
                recognition.onerror = (event) => { console.error('Speech recognition error: ', event.error); promptInput.placeholder = "Error, try again..."; };
            } else {
                voiceInputButton.disabled = true;
            }

            attachFileButton.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        attachedImageBase64 = reader.result.split(',')[1];
                        imagePreview.src = reader.result;
                        imagePreviewContainer.classList.remove('hidden');
                    };
                    reader.readAsDataURL(file);
                }
            });
            clearImageButton.addEventListener('click', () => {
                attachedImageBase64 = null;
                imagePreviewContainer.classList.add('hidden');
                imagePreview.src = '';
                fileInput.value = '';
            });

            askAllButton.addEventListener('click', handleSend);
            newChatBtn.addEventListener('click', createNewChat);
            promptInput.addEventListener('keydown', (event) => {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    handleSend();
                }
            });

            hamburgerMenuBtn.addEventListener('click', () => {
                sidebar.classList.add('expanded');
                mainContent.classList.add('sidebar-open');
            });

            sidebar.addEventListener('mouseleave', () => {
                sidebar.classList.remove('expanded');
                mainContent.classList.remove('sidebar-open');
            });

            // Add a click listener to the entire document
            document.addEventListener('click', (event) => {
                // Check if the sidebar is expanded
                if (sidebar.classList.contains('expanded')) {
                    // Check if the click occurred outside of the sidebar AND outside of the hamburger button.
                    if (!sidebar.contains(event.target) && !hamburgerMenuBtn.contains(event.target)) {
                        sidebar.classList.remove('expanded');
                        mainContent.classList.remove('sidebar-open');
                    }
                }
            });

            loadHistory();

            // Function to create and add particles
            const createParticles = () => {
                for (let i = 0; i < 80; i++) {
                    const particle = document.createElement('div');
                    particle.classList.add('particle');

                    const size = Math.random() * 5 + 2; // Size between 2px and 7px
                    particle.style.width = `${size}px`;
                    particle.style.height = `${size}px`;

                    const left = Math.random() * 100;
                    const top = Math.random() * 100;
                    particle.style.left = `${left}vw`;
                    particle.style.top = `${top}vh`;

                    // Randomize the duration to vary the speed of each particle
                    const duration = Math.random() * 30 + 15; // Random duration between 15s and 45s
                    const delay = Math.random() * 5; // Delay between 0s and 5s
                    particle.style.animationDuration = `${duration}s`;
                    particle.style.animationDelay = `${delay}s`;

                    particleBg.appendChild(particle);
                }
            };

            createParticles();
        });
    </script>
</body>
</html>
